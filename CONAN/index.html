<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Formulaire de Connexion</title>
    <link rel="stylesheet" href="connexion.css">
</head>
<body>
    <!-- Formulaire de Connexion -->
    <div class="form-container">
        <form id="loginForm">
            <input type="hidden" name="action" value="login">
            <label for="numero_de_telephone">Numéro de téléphone :</label>
            <input type="text" id="numero_de_telephone" name="numero_de_telephone" required pattern="[0-9]{10}" placeholder="Numéro de téléphone">

            <label for="password">Mot de passe :</label>
            <input type="password" id="password" name="password" required placeholder="Mot de passe">

            <input type="submit" value="Se connecter" class="connect-btn">

            <!-- Bouton pour gérer les utilisateurs (ouvre une popup) -->
            <button type="button" class="gestion-btn nouvelle-classe" onclick="ouvrirPopup('popupAdmin')">Gestion des utilisateurs</button>
        </form>
    </div>

    <!-- Overlay pour les pop-ups -->
    <div id="overlay" class="overlay" onclick="fermerPopupTous()"></div>

    <!-- Popup de validation pour l'accès admin -->
    <div id="popupAdmin" class="popup">
        <form id="adminForm">
            <span class="close" onclick="fermerPopup('popupAdmin')">&times;</span>
            <input type="hidden" name="action" value="admin">
            <label for="mdp_admin">Mot de passe administrateur :</label>
            <input type="password" id="mdp_admin" name="mdp_admin" required placeholder="Mot de passe">
            <div class="button-container">
                <button type="submit">Valider</button>
                <button type="button" onclick="fermerPopup('popupAdmin')">Annuler</button>
            </div>
        </form>
    </div>

    <!-- Popup pour gérer Ajout / Modification / Suppression -->
    <div id="popupGestion" class="modal-overlay">
        <div class="modal">
            <button class="close-button" onclick="fermerPopup('popupGestion')">&times;</button>
            <div class="modal-header">Gestion des utilisateurs</div>
            <div class="modal-buttons">
                <button type="button" onclick="ouvrirFormPopup('ajout')">Ajouter un utilisateur</button>
                <button type="button" onclick="ouvrirFormPopup('modifier')">Modifier un utilisateur</button>
                <button type="button" onclick="ouvrirFormPopup('supprimer')">Supprimer un utilisateur</button>
                <button type="button" class="cancel" onclick="fermerPopup('popupGestion')">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Formulaire Ajout Utilisateur -->
    <div id="popupAjout" class="modal-overlay">
        <div class="modal">
            <button class="close-button" onclick="fermerPopup('popupAjout')">&times;</button>
            <div class="modal-header">Ajouter un utilisateur</div>
            <form id="ajoutForm">
                <input type="hidden" name="action" value="ajout">
                <div class="modal-body">
                    <label for="numero">Numéro de téléphone :</label>
                    <input type="text" id="numero" name="numero" required pattern="[0-9]{10}" placeholder="Numéro de téléphone">

                    <label for="conf_numero">Confirmer le numéro :</label>
                    <input type="text" id="conf_numero" name="conf_numero" required pattern="[0-9]{10}" placeholder="Confirmer le numéro">

                    <label for="password">Mot de passe :</label>
                    <input type="password" id="password" name="password" required placeholder="Mot de passe">

                    <label for="conf_password">Confirmer le mot de passe :</label>
                    <input type="password" id="conf_password" name="conf_password" required placeholder="Confirmer le mot de passe">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="validate" onclick="fermerPopup('popupAjout')">Ajouter</button>
                    <button type="button" class="cancel" onclick="fermerPopup('popupAjout')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Formulaire Modification Utilisateur -->
    <div id="popupModifier" class="modal-overlay">
        <div class="modal">
            <button class="close-button" onclick="fermerPopup('popupModifier')">&times;</button>
            <div class="modal-header">Modifier le mot de passe</div>
            <form id="modifierForm">
                <input type="hidden" name="action" value="modifier">
                <div class="modal-body">
                    <label for="num_modif">Numéro de téléphone :</label>
                    <input type="text" id="num_modif" name="numero" required pattern="[0-9]{10}" placeholder="Numéro de téléphone">

                    <label for="ancien_password">Mot de passe actuel :</label>
                    <input type="password" id="ancien_password" name="ancien_password" required placeholder="Mot de passe actuel">

                    <label for="new_password">Nouveau mot de passe :</label>
                    <input type="password" id="new_password" name="new_password" required placeholder="Nouveau mot de passe">

                    <label for="conf_new_password">Confirmer le nouveau mot de passe :</label>
                    <input type="password" id="conf_new_password" name="conf_new_password" required placeholder="Confirmer le nouveau mot de passe">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="validate" onclick="fermerPopup('popupAjout')">Modifier</button>
                    <button type="button" class="cancel" onclick="fermerPopup('popupModifier')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Formulaire Suppression Utilisateur -->
    <div id="popupSupprimer" class="modal-overlay">
        <div class="modal">
            <button class="close-button" onclick="fermerPopup('popupSupprimer')">&times;</button>
            <div class="modal-header">Supprimer un utilisateur</div>
            <form id="supprimerForm">
                <input type="hidden" name="action" value="supprimer">
                <div class="modal-body">
                    <label for="num_supp">Numéro de téléphone :</label>
                    <input type="text" id="num_supp" name="numero" required pattern="[0-9]{10}" placeholder="Numéro de téléphone">

                    <label for="conf_num_supp">Confirmer le numéro :</label>
                    <input type="text" id="conf_num_supp" name="conf_numero" required pattern="[0-9]{10}" placeholder="Confirmer le numéro">

                    <label for="password_supp">Mot de passe actuel :</label>
                    <input type="password" id="password_supp" name="password" required placeholder="Mot de passe actuel">

                    <label for="conf_password_supp">Confirmer le mot de passe :</label>
                    <input type="password" id="conf_password_supp" name="conf_password" required placeholder="Confirmer le mot de passe">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="validate" onclick="fermerPopup('popupAjout')">Supprimer</button>
                    <button type="button" class="cancel" onclick="fermerPopup('popupSupprimer')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Popup de confirmation -->
    <!-- Popup d'alerte -->
    <div id="alertPopup" class="popup">
        <div class="alert-content">
            <span class="close" onclick="fermerPopup('alertPopup')">&times;</span>
            <div id="alertMessage">Ceci est un message d'alerte.</div>
            <button type="button" class="validate" onclick="fermerPopup('alertPopup')">OK</button>
        </div>
    </div>

    <script>
        window.onload = function() {
            // Assurez-vous que toutes les popups sont fermées au chargement de la page
            fermerPopupTous();
        };

        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            handleFormSubmit(this, 'données_physico_chimiques.php');
        });

        document.getElementById('adminForm').addEventListener('submit', function(event) {
            event.preventDefault();
            handleFormSubmit(this, null, 'popupGestion');
        });

        document.getElementById('ajoutForm').addEventListener('submit', function(event) {
            event.preventDefault();
            handleFormSubmit(this);
        });

        document.getElementById('modifierForm').addEventListener('submit', function(event) {
            event.preventDefault();
            handleFormSubmit(this);
        });

        document.getElementById('supprimerForm').addEventListener('submit', function(event) {
            event.preventDefault();
            handleFormSubmit(this);
        });

        function handleFormSubmit(form, redirectUrl = null, popupId = null) {
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "connexion.php", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        if (redirectUrl) {
                            window.location.href = redirectUrl;
                        } else if (popupId) {
                            fermerPopup(form.closest('.popup').id);
                            ouvrirPopup(popupId);
                        } else {
                            // Afficher un message de confirmation générique dans la popup d'alerte
                            var action = form.querySelector('input[name="action"]').value;
                            var message = "L'utilisateur a bien été ";
                            switch(action) {
                                case 'ajout':
                                    message += "ajouté.";
                                    break;
                                case 'modifier':
                                    message += "modifié.";
                                    break;
                                case 'supprimer':
                                    message += "supprimé.";
                                    break;
                                default:
                                    message = response.message || "Opération réussie.";
                            }
                            ouvrirAlertPopup(message);
                        }
                    } else {
                        // Afficher un message d'erreur dans la popup d'alerte
                        ouvrirAlertPopup(response.message || "Une erreur est survenue.");
                    }
                }
            };
            xhr.send(formData);
        }

        function ouvrirAlertPopup(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertPopup').style.display = 'flex';
        }

        function fermerPopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
        }

        function ouvrirPopup(popupId) {
            document.body.classList.add('flou');
            document.getElementById("overlay").style.display = "block";
            document.getElementById(popupId).style.display = "flex";
        }

        function fermerPopup(popupId) {
            document.body.classList.remove('flou');
            document.getElementById(popupId).style.display = "none";
            document.getElementById("overlay").style.display = "none";
        }

        function fermerPopupTous() {
            const popups = document.querySelectorAll('.popup, .modal-overlay');
            popups.forEach(function(popup) {
                popup.style.display = 'none';
            });
            document.getElementById("overlay").style.display = "none";
            document.body.classList.remove('flou');
        }

        function ouvrirFormPopup(type) {
            fermerPopupTous();
            document.getElementById("overlay").style.display = "block";
            document.getElementById("popup" + type.charAt(0).toUpperCase() + type.slice(1)).style.display = "flex";
        }
    </script>
</body>
</html>
